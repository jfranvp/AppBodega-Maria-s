<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>App Bodega</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <style>
    body{
      font-family:'Inter',sans-serif;background:#e0e5ec;color:#4b5563;
      display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;
    }
    .neumorphic-card{background:#e0e5ec;border-radius:2rem;box-shadow:9px 9px 16px #a3b1c6,-9px -9px 16px #fff;transition:.3s}
    .neumorphic-inset{background:#e0e5ec;border-radius:1rem;box-shadow:inset 5px 5px 10px #a3b1c6,inset -5px -5px 10px #fff}
    .neumorphic-button{background:#e0e5ec;border-radius:50%;width:4rem;height:4rem;display:flex;justify-content:center;align-items:center;box-shadow:5px 5px 10px #a3b1c6,-5px -5px 10px #fff;transition:.3s}
    .neumorphic-button:active{box-shadow:inset 5px 5px 10px #a3b1c6,inset -5px -5px 10px #fff}
    .neumorphic-text-input{background:#e0e5ec;border-radius:.75rem;box-shadow:inset 2px 2px 5px #a3b1c6,inset -2px -2px 5px #fff;padding:.75rem;width:100%;outline:none;border:none}
    .payment-button{background:#e0e5ec;border-radius:.75rem;padding:.75rem 1.5rem;box-shadow:5px 5px 10px #a3b1c6,-5px -5px 10px #fff;transition:.3s}
    .payment-button.active{box-shadow:inset 5px 5px 10px #a3b1c6,inset -5px -5px 10px #fff;color:#3b82f6}
    .side-menu{position:fixed;top:0;left:0;width:250px;height:100%;background:#e0e5ec;box-shadow:9px 9px 16px #a3b1c6,-9px -9px 16px #fff;transform:translateX(-100%);transition:transform .3s;z-index:50}
    .side-menu.open{transform:translateX(0)}
    .menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:40;opacity:0;visibility:hidden;transition:.3s}
    .menu-overlay.visible{opacity:1;visibility:visible}
    .autocomplete-container{position:relative;width:100%}
    .autocomplete-list{position:absolute;top:100%;left:0;right:0;z-index:10;background:#e0e5ec;border-radius:.75rem;box-shadow:5px 5px 10px #a3b1c6,-5px -5px 10px #fff;max-height:150px;overflow-y:auto}
    .autocomplete-item{padding:.75rem;cursor:pointer;transition:background-color .2s}
    .autocomplete-item:hover{background:#d1d9e6}
    .tab-button{padding:.75rem 1.5rem;border-radius:1rem;cursor:pointer;transition:.3s}
    .tab-button.active{box-shadow:inset 5px 5px 10px #a3b1c6,inset -5px -5px 10px #fff;font-weight:600}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:100}
    .modal-content{background:#e0e5ec;border-radius:1rem;padding:2rem;box-shadow:9px 9px 16px #a3b1c6,-9px -9px 16px #fff;width:90%;max-width:500px}
    .message-modal{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#e0e5ec;border-radius:1rem;box-shadow:5px 5px 10px #a3b1c6,-5px -5px 10px #fff;padding:1rem;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:.3s;z-index:99}
    .message-modal.show{opacity:1;visibility:visible}
  </style>
</head>
<body class="bg-[#e0e5ec] text-gray-600">
  <!-- Contenedor principal -->
  <div class="neumorphic-card w-[95%] max-w-2xl h-[95vh] flex flex-col p-6 space-y-6">
    <!-- Header -->
    <header class="flex justify-between items-center pb-4 border-b border-gray-300">
      <h1 class="text-3xl font-bold tracking-tight">Bodega Maria's</h1>
      <div id="menu-button" class="neumorphic-button cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
        </svg>
      </div>
    </header>

    <!-- Contenido -->
    <main class="flex-grow p-4 overflow-y-auto">
      <!-- Productos -->
      <div id="module-productos" class="module">
        <h2 class="text-xl font-semibold mb-4">Gestión de Productos</h2>
        <div class="neumorphic-inset p-4 mb-4">
          <input type="text" id="search-products" placeholder="Buscar producto..." class="neumorphic-text-input mb-4">
          <div id="products-list" class="space-y-3 max-h-56 overflow-y-auto"></div>
        </div>

        <div class="neumorphic-inset p-4 mt-4">
          <h3 class="font-semibold mb-2" id="form-title">Agregar Producto</h3>
          <input type="hidden" id="product-id">
          <div class="mb-2">
            <label for="product-name" class="text-sm font-medium mb-1">Nombre:</label>
            <input type="text" id="product-name" class="neumorphic-text-input w-full" placeholder="Nombre del producto">
          </div>
          <div class="mb-2">
            <label for="product-price" class="text-sm font-medium mb-1">Precio:</label>
            <input type="number" id="product-price" class="neumorphic-text-input w-full" placeholder="Precio">
          </div>
          <div class="mb-2">
            <label for="product-stock" class="text-sm font-medium mb-1">Stock (ej: 23.45):</label>
            <input type="text" id="product-stock" class="neumorphic-text-input w-full" placeholder="Cantidad en stock">
          </div>
          <div class="mb-2">
            <label for="stock-unit" class="text-sm font-medium mb-1">Unidad de medida:</label>
            <select id="stock-unit" class="neumorphic-text-input w-full">
              <option value="UN">Unidad</option>
              <option value="KG">Kilo</option>
            </select>
          </div>
          <div class="mb-2">
            <label for="product-expiry" class="text-sm font-medium mb-1">Fecha de Caducidad:</label>
            <input type="date" id="product-expiry" class="neumorphic-text-input w-full">
          </div>
        </div>
        <button id="submit-product-btn" class="neumorphic-button w-full h-12 rounded-full cursor-pointer hover:scale-105 mt-4">
          <span id="submit-text" class="text-gray-500 font-medium">Agregar Producto</span>
        </button>
      </div>

      <!-- Ventas -->
      <div id="module-ventas" class="module hidden">
        <h2 class="text-xl font-semibold mb-4">Registro de Ventas</h2>
        <div class="neumorphic-inset p-4">
          <div class="mb-4">
            <p class="text-sm font-medium mb-1">Fecha y Hora:</p>
            <p id="sale-datetime" class="neumorphic-text-input text-gray-500 font-medium"></p>
          </div>
          <div class="mb-4">
            <label for="search-product" class="text-sm font-medium mb-1">Producto:</label>
            <div class="autocomplete-container">
              <input type="text" id="search-product" placeholder="Escribe el producto" class="neumorphic-text-input w-full">
              <div id="autocomplete-list" class="autocomplete-list hidden"></div>
            </div>
          </div>
          <div class="mb-4">
            <label for="quantity" class="text-sm font-medium mb-1">Cantidad:</label>
            <input type="number" id="quantity" value="1" min="0.01" step="0.01" class="neumorphic-text-input w-full">
          </div>
          <div class="mb-4">
            <label for="customer-name" class="text-sm font-medium mb-1">Cliente:</label>
            <input type="text" id="customer-name" placeholder="Nombre del cliente" class="neumorphic-text-input w-full">
          </div>

          <div class="flex space-x-2 mt-2">
            <button id="add-to-cart-btn" class="neumorphic-button w-full h-12 rounded-full cursor-pointer hover:scale-105">
              <span class="text-gray-500 font-medium">Agregar</span>
            </button>
            <button id="record-sale-btn" class="neumorphic-button w-full h-12 rounded-full cursor-pointer hover:scale-105">
              <span class="text-gray-500 font-medium">Venta</span>
            </button>
          </div>

          <div class="mt-4 flex justify-between space-x-2">
            <button id="payment-cash" class="payment-button active w-1/2"><span>Contado</span></button>
            <button id="payment-credit" class="payment-button w-1/2"><span>Fiado</span></button>
          </div>

          <div class="mt-4">
            <h3 class="font-medium mb-2">Resumen del Carrito</h3>
            <ul id="cart-summary" class="neumorphic-inset p-3 space-y-2"></ul>
          </div>
        </div>
      </div>

      <!-- Créditos -->
      <div id="module-creditos" class="module hidden">
        <h2 class="text-xl font-semibold mb-4">Gestión de Créditos</h2>
        <div id="credits-list-container" class="neumorphic-inset p-4">
          <p class="mb-4 text-sm text-gray-500">Haz clic en una deuda para ver detalle y generar PDF.</p>
          <ul id="credits-list" class="space-y-3 max-h-56 overflow-y-auto"></ul>
        </div>

        <div id="credit-detail-container" class="hidden neumorphic-inset p-4 mt-4">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Detalle de la Deuda</h3>
            <button id="close-detail-btn" class="neumorphic-button w-8 h-8 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <p class="text-lg text-gray-500 mb-2">Cliente:
            <span id="detail-nombre-cliente" class="font-bold text-blue-600"></span>
          </p>
          <p class="text-sm text-gray-500">Fecha: <span id="detail-fecha"></span> - Hora: <span id="detail-hora"></span></p>

          <div class="flex justify-between items-center mt-4 p-4 rounded-lg bg-gray-200">
            <span class="text-xl font-semibold">Total de la Deuda:</span>
            <span id="detail-total-deuda" class="text-2xl font-bold text-red-500"></span>
          </div>

          <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Productos Comprados:</h4>
          <ul id="detail-items-list" class="neumorphic-inset p-3 space-y-2 mb-4"></ul>

          <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-4">
            <button id="btn-generar-pdf" class="w-full md:w-auto px-6 py-3 bg-red-600 text-white font-bold rounded-full shadow-md hover:bg-red-700 transition hover:scale-105">Generar PDF</button>
            <button id="btn-enviar-whatsapp" class="w-full md:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-md hover:bg-green-700 transition hover:scale-105">Enviar por WhatsApp</button>
          </div>
        </div>
      </div>

      <!-- Reportes -->
      <div id="module-reportes" class="module hidden">
        <h2 class="text-xl font-semibold mb-4">Reportes de Negocio</h2>
        <div class="neumorphic-inset p-4 space-y-4">
          <div class="neumorphic-card p-4">
            <h3 class="font-medium text-lg mb-2">Resumen de Ventas</h3>
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm font-medium">Ventas de Hoy:</span>
              <span id="sales-today" class="text-lg font-bold">S/ 0.00</span>
            </div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm font-medium">Ventas de la Semana:</span>
              <span id="sales-week" class="text-lg font-bold">S/ 0.00</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium">Ventas del Mes:</span>
              <span id="sales-month" class="text-lg font-bold">S/ 0.00</span>
            </div>
          </div>

          <div class="neumorphic-card p-4">
            <h3 class="font-medium text-lg mb-2">Inventario Bajo (Stock &lt; 5)</h3>
            <ul id="low-stock-list" class="list-disc list-inside mt-2 space-y-1">
              <li class="text-gray-500">No hay productos con bajo stock.</li>
            </ul>
          </div>

          <div class="neumorphic-card p-4">
            <h3 class="font-medium text-lg mb-2">Productos Más Vendidos</h3>
            <ul id="top-products-list" class="list-decimal list-inside mt-2 space-y-1">
              <li class="text-gray-500">No hay productos vendidos todavía.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Clientes -->
      <div id="module-clientes" class="module hidden">
        <div id="client-list-view">
          <h2 class="text-xl font-semibold mb-4">Gestión de Clientes</h2>

          <div class="neumorphic-inset p-4 mb-4">
            <h3 class="font-semibold mb-2" id="client-form-title">Agregar Cliente</h3>
            <input type="hidden" id="client-id">
            <div class="mb-2">
              <label for="client-name" class="text-sm font-medium mb-1">Nombre:</label>
              <input type="text" id="client-name" class="neumorphic-text-input w-full" placeholder="Nombre completo">
            </div>
            <div class="mb-2">
              <label for="client-phone" class="text-sm font-medium mb-1">Teléfono:</label>
              <input type="tel" id="client-phone" class="neumorphic-text-input w-full" placeholder="Número de teléfono">
            </div>
            <div class="mb-2">
              <label for="client-notes" class="text-sm font-medium mb-1">Notas:</label>
              <textarea id="client-notes" rows="3" class="neumorphic-text-input w-full" placeholder="Notas sobre el cliente"></textarea>
            </div>
            <button id="submit-client-btn" class="neumorphic-button w-full h-12 rounded-full cursor-pointer hover:scale-105 mt-4">
              <span id="submit-client-text" class="text-gray-500 font-medium">Agregar Cliente</span>
            </button>
          </div>

          <div class="neumorphic-inset p-4">
            <input type="text" id="search-client-input" placeholder="Buscar cliente..." class="neumorphic-text-input mb-4">
            <div id="clients-list" class="space-y-3 max-h-56 overflow-y-auto"></div>
          </div>
        </div>

        <div id="client-detail-view" class="hidden">
          <div class="flex justify-between items-center mb-4">
            <button id="back-to-clients-btn" class="neumorphic-button w-8 h-8 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
            </button>
            <h2 class="text-xl font-semibold" id="client-detail-name"></h2>
            <div class="flex space-x-2">
              <button id="edit-client-detail-btn" class="neumorphic-button w-8 h-8 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
              </button>
              <button id="delete-client-detail-btn" class="neumorphic-button w-8 h-8 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="neumorphic-inset p-4 mb-4">
            <p class="text-sm">Teléfono: <span id="client-detail-phone" class="font-semibold"></span></p>
            <p class="text-sm mt-1">Notas: <span id="client-detail-notes" class="font-semibold"></span></p>
          </div>

          <div class="flex justify-center space-x-4 mb-4">
            <button id="tab-historial" class="tab-button neumorphic-card active">Historial de Compras</button>
            <button id="tab-creditos-cliente" class="tab-button neumorphic-card">Créditos</button>
          </div>

          <div id="historial-content" class="tab-content active neumorphic-inset p-4 max-h-56 overflow-y-auto">
            <ul id="client-sales-history" class="space-y-3"></ul>
          </div>
          <div id="creditos-cliente-content" class="tab-content neumorphic-inset p-4 max-h-56 overflow-y-auto">
            <ul id="client-credits" class="space-y-3"></ul>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Menú lateral -->
  <div id="side-menu" class="side-menu p-6">
    <h2 class="text-2xl font-bold mb-6">Menú</h2>
    <nav class="flex flex-col space-y-6">
      <div class="neumorphic-button h-16 w-full rounded-2xl flex-grow flex-row justify-start space-x-4 items-center pl-6 cursor-pointer hover:scale-[1.02]" data-module="productos">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zm-7 10h2a2 2 0 002-2v-2a2 2 0 00-2-2H9a2 2 0 00-2 2v2a2 2 0 002 2z"/>
        </svg>
        <span class="text-lg font-medium">Productos</span>
      </div>
      <div class="neumorphic-button h-16 w-full rounded-2xl flex-grow flex-row justify-start space-x-4 items-center pl-6 cursor-pointer hover:scale-[1.02]" data-module="ventas">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
        </svg>
        <span class="text-lg font-medium">Ventas</span>
      </div>
      <div class="neumorphic-button h-16 w-full rounded-2xl flex-grow flex-row justify-start space-x-4 items-center pl-6 cursor-pointer hover:scale-[1.02]" data-module="creditos">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8a4 4 0 00-4 4v2m4-2a4 4 0 014 4v2m-4-2c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/>
        </svg>
        <span class="text-lg font-medium">Créditos</span>
      </div>
      <div class="neumorphic-button h-16 w-full rounded-2xl flex-grow flex-row justify-start space-x-4 items-center pl-6 cursor-pointer hover:scale-[1.02]" data-module="reportes">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        <span class="text-lg font-medium">Reportes</span>
      </div>
      <div class="neumorphic-button h-16 w-full rounded-2xl flex-grow flex-row justify-start space-x-4 items-center pl-6 cursor-pointer hover:scale-[1.02]" data-module="clientes">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        <span class="text-lg font-medium">Clientes</span>
      </div>
    </nav>
  </div>
  <div id="menu-overlay" class="menu-overlay"></div>

  <!-- Modal WhatsApp -->
  <div id="whatsapp-modal" class="modal">
    <div class="modal-content">
      <h3 class="text-xl font-semibold mb-4">Mensaje de Deuda</h3>
      <p class="text-sm mb-2">Copia el siguiente mensaje o abre WhatsApp directamente:</p>
      <textarea id="whatsapp-message-text" rows="8" readonly class="neumorphic-text-input w-full p-4"></textarea>
      <div class="flex flex-col space-y-2 mt-4">
        <a id="open-whatsapp-btn" href="#" target="_blank" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-full shadow-md hover:bg-green-700 transition hover:scale-105 text-center">Abrir en WhatsApp</a>
        <button id="copy-whatsapp-message-btn" class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-md hover:bg-blue-700 transition hover:scale-105">Copiar Mensaje</button>
      </div>
      <button id="close-whatsapp-modal-btn" class="w-full mt-4 px-6 py-3 bg-gray-400 text-white font-bold rounded-full shadow-md hover:bg-gray-500 transition hover:scale-105">Cerrar</button>
    </div>
  </div>

  <script>
    /* ====== CONFIG API (Google Apps Script) ====== */
    const API_BASE = "https://script.google.com/macros/s/AKfycbzhcGnaE_Hrbmus8c6gYyw-camA8Z6pxo8pptn5MYShUazVEK5jmslO4-61ilyXXWY6/exec";

    async function api(action, data = {}) {
      try {
        const res = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action, data })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (json.ok === false) throw new Error(json.message || "Error API");
        return json;
      } catch (err) {
        console.error("API error:", action, err);
        showMessage("Error de conexión con Sheets.");
        return { ok: false, data: null };
      }
    }

    /* ====== ESTADO ====== */
    let allProducts = [];
    let allCredits  = [];
    let allSales    = [];
    let allClients  = [];
    let cart = [];
    let selectedProduct = null;
    let currentCreditForPDF = null;
    let currentClient = null;

    /* ====== PRODUCTOS ====== */
    async function saveOrUpdateProduct(){
      const productId = document.getElementById('product-id').value.trim();
      const name = document.getElementById('product-name').value.trim();
      const price = parseFloat(document.getElementById('product-price').value);
      const stock = parseFloat(document.getElementById('product-stock').value);
      const expiry = document.getElementById('product-expiry').value;
      const unit = document.getElementById('stock-unit').value;

      if (!name || isNaN(price) || isNaN(stock) || !expiry || !unit){
        console.error("Completa todos los campos.");
        showMessage("Completa todos los campos.");
        return;
      }
      const payload = { id: productId || null, nombre: name, precio: price, stock, unidad: unit, caducidad: expiry };
      const action  = productId ? "ACTUALIZAR_PRODUCTO" : "GUARDAR_PRODUCTO";
      const { ok } = await api(action, payload);
      if (ok){
        resetForm();
        await listenForProducts();
        updateReports();
        showMessage(productId ? "Producto actualizado" : "Producto guardado");
      }
    }

    async function deleteProduct(productId){
      const { ok } = await api("ELIMINAR_PRODUCTO", { id: productId });
      if (ok){
        await listenForProducts();
        updateReports();
        showMessage("Producto eliminado");
      }
    }

    function editProduct(product){
      document.getElementById('form-title').innerText = 'Editar Producto';
      document.getElementById('submit-text').innerText = 'Actualizar Producto';
      document.getElementById('product-id').value = product.id;
      document.getElementById('product-name').value = product.name;
      document.getElementById('product-price').value = product.price;
      document.getElementById('product-stock').value = product.stock;
      document.getElementById('product-expiry').value = product.expiry;
      document.getElementById('stock-unit').value = product.unit || 'UN';
    }

    function resetForm(){
      document.getElementById('form-title').innerText = 'Agregar Producto';
      document.getElementById('submit-text').innerText = 'Agregar Producto';
      document.getElementById('product-id').value = '';
      document.getElementById('product-name').value = '';
      document.getElementById('product-price').value = '';
      document.getElementById('product-stock').value = '';
      document.getElementById('product-expiry').value = '';
      document.getElementById('stock-unit').value = 'UN';
    }

    function displayProducts(products){
      const list = document.getElementById('products-list');
      list.innerHTML = '';
      const term = (document.getElementById('search-products').value || '').toLowerCase();
      const filtered = term ? products.filter(p=>p.name.toLowerCase().includes(term)) : products;

      if (filtered.length===0){
        list.innerHTML = '<div class="text-sm text-gray-400">No hay productos.</div>';
        return;
      }
      filtered.forEach(p=>{
        const row = document.createElement('div');
        row.className = 'neumorphic-card p-3 flex justify-between items-center text-sm';
        row.dataset.id = p.id;
        row.innerHTML = `
          <div class="flex flex-col flex-grow cursor-pointer">
            <span class="font-bold">${p.name}</span>
            <span class="text-xs text-gray-500">Stock: ${p.stock} ${p.unit}</span>
            <span class="text-xs text-gray-500">Caducidad: ${p.expiry}</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="font-bold">S/ ${Number(p.price).toFixed(2)}</span>
            <button class="delete-product-btn p-2 rounded-full neumorphic-button hover:bg-red-400" title="Eliminar">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/>
              </svg>
            </button>
          </div>
        `;
        row.querySelector('.flex-grow').addEventListener('click', ()=>editProduct(p));
        row.querySelector('.delete-product-btn').addEventListener('click', ()=>deleteProduct(p.id));
        list.appendChild(row);
      });
      window.products = products;
    }

    async function listenForProducts(){
      const { ok, data } = await api("LISTAR_PRODUCTOS");
      if (ok){
        // normalizamos nombres
        allProducts = (data || []).map(r => ({
          id: r.ID, name: r.Nombre, price: Number(r.Precio||0), stock: parseFloat(r.Stock||0),
          unit: r.Unidad || "UN", expiry: r.Caducidad || ""
        }));
        displayProducts(allProducts);
        updateReports();
      }
    }

    /* ====== VENTAS / CARRITO ====== */
    const searchInput = document.getElementById('search-product');
    const autocompleteList = document.getElementById('autocomplete-list');
    const quantityInput = document.getElementById('quantity');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const cartSummary = document.getElementById('cart-summary');
    const recordSaleBtn = document.getElementById('record-sale-btn');

    document.getElementById('search-products').addEventListener('input', ()=>displayProducts(allProducts));

    searchInput.addEventListener('input', ()=>{
      const q = searchInput.value.toLowerCase();
      autocompleteList.innerHTML = '';
      if (q.length>1){
        const filtered = allProducts.filter(p=>p.name.toLowerCase().includes(q));
        if (filtered.length>0){
          autocompleteList.classList.remove('hidden');
          filtered.forEach(p=>{
            const item = document.createElement('div');
            item.className='autocomplete-item';
            item.innerText=p.name;
            item.addEventListener('click',()=>{
              searchInput.value=p.name;
              selectedProduct=p;
              autocompleteList.classList.add('hidden');
            });
            autocompleteList.appendChild(item);
          });
        } else autocompleteList.classList.add('hidden');
      } else autocompleteList.classList.add('hidden');
    });

    document.addEventListener('click', (e)=>{
      if(!e.target.closest('.autocomplete-container')) autocompleteList.classList.add('hidden');
    });

    addToCartBtn.addEventListener('click', ()=>{
      if(!selectedProduct){ console.error("Selecciona un producto."); showMessage("Selecciona un producto."); return; }
      const qty = parseFloat(parseFloat(quantityInput.value).toFixed(2));
      if (isNaN(qty) || qty<=0){ console.error("Cantidad inválida."); showMessage("Cantidad inválida."); return; }
      if (qty>selectedProduct.stock){ console.error("Stock insuficiente."); showMessage("Stock insuficiente."); return; }

      const i = cart.findIndex(x=>x.id===selectedProduct.id);
      if (i>-1){
        const newQ = parseFloat(cart[i].quantity) + qty;
        if (newQ>selectedProduct.stock){ console.error("Excede stock."); showMessage("Excede stock."); return; }
        cart[i].quantity = parseFloat(newQ.toFixed(2));
      } else {
        cart.push({ id:selectedProduct.id, name:selectedProduct.name, price:selectedProduct.price, quantity:qty, unit:selectedProduct.unit });
      }
      renderCart(); resetSaleForm();
    });

    function renderCart(){
      cartSummary.innerHTML = '';
      if(cart.length===0){
        cartSummary.innerHTML = '<li class="text-sm text-gray-400">El carrito está vacío.</li>';
        return;
      }
      let total=0;
      cart.forEach(item=>{
        const li=document.createElement('li');
        li.className='neumorphic-card p-2 flex justify-between items-center text-sm';
        const subtotal=item.price*item.quantity;
        li.innerHTML=`<span>${item.name} x ${item.quantity} ${item.unit}</span><span class="font-bold">S/ ${subtotal.toFixed(2)}</span>`;
        total+=subtotal; cartSummary.appendChild(li);
      });
      const totalLi=document.createElement('li');
      totalLi.className='mt-2 border-t pt-2 border-gray-300 flex justify-between items-center text-base font-bold';
      totalLi.innerHTML=`<span>Total:</span><span>S/ ${total.toFixed(2)}</span>`;
      cartSummary.appendChild(totalLi);
    }

    function resetSaleForm(){
      searchInput.value=''; quantityInput.value='1'; selectedProduct=null; autocompleteList.classList.add('hidden');
    }

    // Pago: contado/fiado
    const btnCash = document.getElementById('payment-cash');
    const btnCredit = document.getElementById('payment-credit');
    btnCash.addEventListener('click', ()=>{ btnCash.classList.add('active'); btnCredit.classList.remove('active'); });
    btnCredit.addEventListener('click', ()=>{ btnCredit.classList.add('active'); btnCash.classList.remove('active'); });

    // Registrar venta
    recordSaleBtn.addEventListener('click', async ()=>{
      if (cart.length===0){ console.error("Carrito vacío."); showMessage("Carrito vacío."); return; }

      const customerName = document.getElementById('customer-name').value.trim() || 'Cliente Anónimo';
      const paymentType = document.querySelector('.payment-button.active').innerText.trim();
      const total = cart.reduce((s,i)=>s+i.price*i.quantity,0);

      const payload = { cliente: customerName, tipoPago: paymentType, items: cart, total };
      const { ok } = await api("REGISTRAR_VENTA", payload);
      if (ok){
        cart=[]; renderCart(); resetSaleForm();
        await Promise.all([listenForProducts(), listenForCredits(), listenForSales()]);
        showMessage("Venta registrada");
      }
    });

    /* ====== CRÉDITOS ====== */
    async function listenForCredits(){
      const { ok, data } = await api("LISTAR_CREDITOS");
      if (ok){
        const parseTs = v => v ? new Date(v) : new Date();
        allCredits = (data||[]).map(c=>({
          id:c.ID, customerName:c.Cliente, total:Number(c.Total||0),
          items: (()=>{ try{return JSON.parse(c.ItemsJSON||"[]")}catch(_){return []} })(),
          timestamp: parseTs(c.Timestamp)
        }));
        displayCredits(allCredits);
      }
    }

    function displayCredits(credits){
      const ul=document.getElementById('credits-list');
      ul.innerHTML='';
      if(credits.length===0){ ul.innerHTML='<li class="text-sm text-gray-400">No hay deudas pendientes.</li>'; return; }
      credits.forEach(c=>{
        const li=document.createElement('li');
        li.className='neumorphic-card p-3 flex justify-between items-center text-sm cursor-pointer hover:bg-gray-100 transition';
        li.dataset.creditId=c.id;
        const date=c.timestamp.toLocaleDateString('es-PE');
        const time=c.timestamp.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'});
        li.innerHTML=`
          <div class="flex flex-col">
            <span class="font-bold">${c.customerName}</span>
            <span class="text-xs text-gray-500">Deuda: S/ ${c.total.toFixed(2)}</span>
            <span class="text-xs text-gray-500">Fecha: ${date} - ${time}</span>
          </div>
          <button class="pay-credit-btn neumorphic-button p-2 rounded-full h-8 w-8 text-green-500 hover:bg-green-400" data-credit-id="${c.id}" title="Marcar pagado">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          </button>
        `;
        ul.appendChild(li);
      });

      ul.querySelectorAll('li').forEach(item=>{
        item.addEventListener('click',(ev)=>{
          if (ev.target.closest('.pay-credit-btn')) return;
          const id=item.dataset.creditId;
          const credit=allCredits.find(x=>x.id===id);
          if (credit) showCreditDetails(credit);
        });
      });

      ul.querySelectorAll('.pay-credit-btn').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          ev.stopPropagation();
          const id=btn.dataset.creditId;
          const { ok } = await api("PAGAR_CREDITO", { id });
          if (ok){ await listenForCredits(); showMessage("Crédito pagado"); }
        });
      });
    }

    function showCreditDetails(credit){
      currentCreditForPDF=credit;
      document.getElementById('credits-list-container').classList.add('hidden');
      document.getElementById('credit-detail-container').classList.remove('hidden');

      document.getElementById('detail-nombre-cliente').textContent=credit.customerName;
      document.getElementById('detail-total-deuda').textContent=`S/ ${credit.total.toFixed(2)}`;
      document.getElementById('detail-fecha').textContent=credit.timestamp.toLocaleDateString('es-PE');
      document.getElementById('detail-hora').textContent=credit.timestamp.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'});

      const list=document.getElementById('detail-items-list');
      list.innerHTML='';
      if (Array.isArray(credit.items)){
        credit.items.forEach(item=>{
          const li=document.createElement('li');
          li.className='neumorphic-card p-2 flex justify-between items-center text-sm';
          const sub=item.price*item.quantity;
          li.innerHTML=`<span>${item.name} x ${item.quantity} ${item.unit}</span><span class="font-bold">S/ ${sub.toFixed(2)}</span>`;
          list.appendChild(li);
        });
      } else {
        list.innerHTML='<li class="text-sm text-gray-400">Detalle no disponible.</li>';
      }
    }

    function generarPDF(){
      if(!currentCreditForPDF) return showMessage("No hay datos para PDF.");
      try{
        const { jsPDF } = window.jspdf;
        const docx = new jsPDF();

        docx.setFontSize(22);
        docx.text('Detalle de la Deuda', 14, 20);
        docx.setFontSize(14);
        docx.text(`Cliente: ${currentCreditForPDF.customerName}`,14,30);
        docx.text('Desglose de transacciones:',14,40);

        const rows = Array.isArray(currentCreditForPDF.items) ? currentCreditForPDF.items.map(item=>[
          currentCreditForPDF.timestamp.toLocaleDateString('es-PE'),
          currentCreditForPDF.timestamp.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'}),
          `${item.name} (${item.quantity} ${item.unit})`,
          `S/ ${(item.price*item.quantity).toFixed(2)}`
        ]) : [];

        docx.autoTable({ startY:50, head:[['Fecha','Hora','Descripción','Monto']], body:rows, theme:'striped', headStyles:{ fillColor:[52,143,226] }});
        const finalY = docx.autoTable.previous.finalY + 10;
        docx.setFontSize(16);
        docx.text(`Total de la Deuda: S/ ${currentCreditForPDF.total.toFixed(2)}`, 14, finalY);

        docx.save(`deuda_${currentCreditForPDF.customerName.replace(/\s/g,'_')}.pdf`);
        showMessage('PDF generado y descargado.');
      }catch(e){ console.error("PDF error:", e); showMessage('Error al generar el PDF.'); }
    }

    /* ====== REPORTES ====== */
    async function listenForSales(){
      const { ok, data } = await api("LISTAR_VENTAS");
      if (ok){
        const parseTs = v => v ? new Date(v) : new Date();
        allSales = (data||[]).map(s=>({
          id:s.ID, customerName:s.Cliente, paymentType:s.TipoPago,
          items:(()=>{try{return JSON.parse(s.ItemsJSON||"[]")}catch(_){return []}})(),
          total:Number(s.Total||0), timestamp:parseTs(s.Timestamp)
        }));
        updateReports();
      }
    }

    function updateReports(){
      const today=new Date();
      const weekAgo=new Date(today); weekAgo.setDate(today.getDate()-7);
      const monthAgo=new Date(today); monthAgo.setMonth(today.getMonth()-1);
      let salesToday=0, salesWeek=0, salesMonth=0;

      allSales.forEach(s=>{
        if (s.timestamp>weekAgo){
          salesWeek += s.total;
          if (s.timestamp.getDate()===today.getDate() && s.timestamp.getMonth()===today.getMonth() && s.timestamp.getFullYear()===today.getFullYear()){
            salesToday += s.total;
          }
        }
        if (s.timestamp>monthAgo) salesMonth += s.total;
      });

      document.getElementById('sales-today').innerText = `S/ ${salesToday.toFixed(2)}`;
      document.getElementById('sales-week').innerText = `S/ ${salesWeek.toFixed(2)}`;
      document.getElementById('sales-month').innerText = `S/ ${salesMonth.toFixed(2)}`;

      const lowUL=document.getElementById('low-stock-list');
      lowUL.innerHTML='';
      const low = allProducts.filter(p=>Number(p.stock)<5);
      if (low.length===0){
        lowUL.innerHTML='<li class="text-gray-500">No hay productos con bajo stock.</li>';
      } else {
        low.forEach(p=>{
          const li=document.createElement('li');
          li.className='text-red-500';
          li.textContent = `${p.name} (Stock: ${p.stock} ${p.unit})`;
          lowUL.appendChild(li);
        });
      }

      updateTopProductsList();
    }

    function updateTopProductsList(){
      const ul=document.getElementById('top-products-list');
      ul.innerHTML='';
      const map=new Map();
      allSales.forEach(s=>{
        if (Array.isArray(s.items)){
          s.items.forEach(i=>{
            const prev=map.get(i.id)||0;
            map.set(i.id, prev + Number(i.quantity||0));
          });
        }
      });
      if (map.size===0){ ul.innerHTML='<li class="text-gray-500">No hay productos vendidos todavía.</li>'; return; }
      const sorted=[...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5);
      sorted.forEach(([id,q])=>{
        const p=allProducts.find(x=>x.id===id); if(!p) return;
        const li=document.createElement('li'); li.className='text-gray-500';
        li.textContent=`${p.name} (${q} ${p.unit} vendidos)`; ul.appendChild(li);
      });
    }

    /* ====== CLIENTES ====== */
    async function saveOrUpdateClient(){
      const id=document.getElementById('client-id').value.trim();
      const name=document.getElementById('client-name').value.trim();
      const phone=document.getElementById('client-phone').value.trim();
      const notes=document.getElementById('client-notes').value.trim();
      if(!name){ console.error("Nombre obligatorio"); showMessage("Nombre obligatorio"); return; }
      const payload={ id: id||null, nombre:name, telefono:phone, notas:notes };
      const action = id ? "ACTUALIZAR_CLIENTE" : "GUARDAR_CLIENTE";
      const { ok } = await api(action, payload);
      if (ok){
        resetClientForm();
        await listenForClients();
        showMessage(id ? "Cliente actualizado" : "Cliente guardado");
      }
    }

    async function deleteClient(clientId){
      const { ok } = await api("ELIMINAR_CLIENTE", { id: clientId });
      if (ok){ await listenForClients(); showMessage("Cliente eliminado"); }
    }

    function editClient(c){
      document.getElementById('client-form-title').innerText='Editar Cliente';
      document.getElementById('submit-client-text').innerText='Actualizar Cliente';
      document.getElementById('client-id').value=c.id;
      document.getElementById('client-name').value=c.name;
      document.getElementById('client-phone').value=c.phone||'';
      document.getElementById('client-notes').value=c.notes||'';
    }

    function resetClientForm(){
      document.getElementById('client-form-title').innerText='Agregar Cliente';
      document.getElementById('submit-client-text').innerText='Agregar Cliente';
      document.getElementById('client-id').value='';
      document.getElementById('client-name').value='';
      document.getElementById('client-phone').value='';
      document.getElementById('client-notes').value='';
    }

    async function listenForClients(){
      const { ok, data } = await api("LISTAR_CLIENTES");
      if (ok){
        allClients=(data||[]).map(r=>({
          id:r.ID, name:r.Nombre, phone:r.Telefono||'', notes:r.Notas||''
        }));
        displayClients(allClients);
      }
    }

    function displayClients(clients){
      const list=document.getElementById('clients-list');
      const term=(document.getElementById('search-client-input').value||'').toLowerCase();
      list.innerHTML='';
      const data = term ? clients.filter(c=>c.name.toLowerCase().includes(term)) : clients;
      if (data.length===0){ list.innerHTML='<li class="text-sm text-gray-400">No se encontraron clientes.</li>'; return; }
      data.forEach(c=>{
        const row=document.createElement('div');
        row.className='neumorphic-card p-3 flex justify-between items-center text-sm cursor-pointer hover:bg-gray-100';
        row.dataset.id=c.id;
        row.innerHTML=`
          <div class="flex flex-col flex-grow">
            <span class="font-bold">${c.name}</span>
            <span class="text-xs text-gray-500">${c.phone||'Sin teléfono'}</span>
          </div>`;
        row.addEventListener('click',()=>showClientDetails(c));
        list.appendChild(row);
      });
    }

    async function showClientDetails(client){
      currentClient=client;
      document.getElementById('client-list-view').classList.add('hidden');
      document.getElementById('client-detail-view').classList.remove('hidden');
      document.getElementById('client-detail-name').textContent=client.name;
      document.getElementById('client-detail-phone').textContent=client.phone||'N/A';
      document.getElementById('client-detail-notes').textContent=client.notes||'—';
      await loadClientSalesHistory();
    }

    async function loadClientSalesHistory(){
      const ul=document.getElementById('client-sales-history');
      ul.innerHTML='<li class="text-sm text-gray-400">Cargando...</li>';
      const { ok, data } = await api("LISTAR_VENTAS", { cliente: currentClient.name });
      if (!ok){ ul.innerHTML='<li class="text-sm text-gray-400">Sin compras.</li>'; return; }
      ul.innerHTML='';
      const rows=(data||[]).filter(s=>s.Cliente===currentClient.name);
      if (rows.length===0){ ul.innerHTML='<li class="text-sm text-gray-400">Sin compras.</li>'; return; }
      rows.forEach(s=>{
        const ts = s.Timestamp ? new Date(s.Timestamp) : new Date();
        const li=document.createElement('li');
        li.className='neumorphic-card p-3 flex flex-col space-y-1';
        const date=ts.toLocaleDateString('es-PE'), time=ts.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'});
        li.innerHTML=`<div class="flex justify-between items-center">
            <span class="font-bold text-gray-700">Total: S/ ${Number(s.Total).toFixed(2)}</span>
            <span class="text-xs text-gray-500">Tipo de Pago: ${s.TipoPago}</span>
          </div>
          <span class="text-xs text-gray-500">Fecha: ${date} - ${time}</span>`;
        ul.appendChild(li);
      });
    }

    async function loadClientCredits(){
      const ul=document.getElementById('client-credits');
      ul.innerHTML='<li class="text-sm text-gray-400">Cargando...</li>';
      const { ok, data } = await api("LISTAR_CREDITOS", { cliente: currentClient.name });
      ul.innerHTML='';
      if (!ok || (data||[]).length===0){ ul.innerHTML='<li class="text-sm text-gray-400">Sin créditos pendientes.</li>'; return; }
      data.forEach(c=>{
        const ts = c.Timestamp ? new Date(c.Timestamp) : new Date();
        const date=ts.toLocaleDateString('es-PE'), time=ts.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'});
        const li=document.createElement('li');
        li.className='neumorphic-card p-3 flex justify-between items-center text-sm';
        li.innerHTML=`
          <div class="flex flex-col">
            <span class="font-bold text-gray-700">Deuda: S/ ${Number(c.Total).toFixed(2)}</span>
            <span class="text-xs text-gray-500">${date} - ${time}</span>
          </div>
          <button class="pay-credit-btn neumorphic-button p-2 rounded-full h-8 w-8 text-green-500" data-credit-id="${c.ID}">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          </button>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll('.pay-credit-btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const { ok } = await api("PAGAR_CREDITO", { id: btn.dataset.creditId });
          if (ok){ await loadClientCredits(); await listenForCredits(); showMessage("Crédito pagado"); }
        });
      });
    }

    /* ====== WHATSAPP ====== */
    function generateWhatsAppMessage(){
      if(!currentCreditForPDF){ console.error("No hay crédito seleccionado."); return; }
      const c=currentCreditForPDF;
      const clientName=c.customerName;
      const total=c.total.toFixed(2);
      const items=Array.isArray(c.items)?c.items:[];
      const date=c.timestamp.toLocaleDateString('es-PE');
      let msg=`¡Hola ${clientName}!\n\nTe recordamos tu deuda pendiente registrada el ${date}.\n\nDetalle:\n`;
      items.forEach(i=>{ msg+=`- ${i.name} (${i.quantity} ${i.unit}) - S/ ${(i.price*i.quantity).toFixed(2)}\n`; });
      msg+=`\n*TOTAL PENDIENTE: S/ ${total}*\n\nGracias por tu preferencia.`;
      document.getElementById('whatsapp-message-text').value=msg;
      const encoded=encodeURIComponent(msg);
      document.getElementById('open-whatsapp-btn').href = `https://wa.me/?text=${encoded}`;
      document.getElementById('whatsapp-modal').style.display='flex';
    }
    function copyWhatsAppMessage(){
      const ta=document.getElementById('whatsapp-message-text');
      ta.select(); document.execCommand('copy'); showMessage("Mensaje copiado al portapapeles.");
    }

    /* ====== UI UTIL ====== */
    function showMessage(text){
      let box=document.querySelector('.message-modal');
      if (!box){
        box=document.createElement('div'); box.className='message-modal'; box.innerText=text;
        document.body.appendChild(box);
      } else { box.innerText=text; }
      box.classList.add('show'); setTimeout(()=>box.classList.remove('show'),2000);
    }

    /* ====== BOOT / EVENTOS ====== */
    document.addEventListener('DOMContentLoaded', ()=>{
      const dt=new Date();
      const saleDt=document.getElementById('sale-datetime');
      if (saleDt) saleDt.textContent = `${dt.toLocaleDateString('es-PE')} ${dt.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'})}`;

      const sideMenu=document.getElementById('side-menu');
      const overlay=document.getElementById('menu-overlay');
      const menuBtn=document.getElementById('menu-button');
      const modules={
        productos:document.getElementById('module-productos'),
        ventas:document.getElementById('module-ventas'),
        creditos:document.getElementById('module-creditos'),
        reportes:document.getElementById('module-reportes'),
        clientes:document.getElementById('module-clientes')
      };
      function switchTo(name){
        Object.values(modules).forEach(m=>m.classList.add('hidden'));
        modules[name].classList.remove('hidden');
        sideMenu.classList.remove('open'); overlay.classList.remove('visible');
      }
      menuBtn.addEventListener('click', ()=>{ sideMenu.classList.add('open'); overlay.classList.add('visible'); });
      overlay.addEventListener('click', ()=>{ sideMenu.classList.remove('open'); overlay.classList.remove('visible'); });
      document.querySelectorAll('[data-module]').forEach(btn=>{
        btn.addEventListener('click', ()=>switchTo(btn.dataset.module));
      });

      document.getElementById('submit-product-btn').addEventListener('click', saveOrUpdateProduct);
      document.getElementById('search-client-input').addEventListener('input', ()=>displayClients(allClients));
      document.getElementById('submit-client-btn').addEventListener('click', saveOrUpdateClient);
      document.getElementById('back-to-clients-btn').addEventListener('click', ()=>{
        document.getElementById('client-detail-view').classList.add('hidden');
        document.getElementById('client-list-view').classList.remove('hidden');
      });
      document.getElementById('tab-historial').addEventListener('click', ()=>{
        document.getElementById('tab-historial').classList.add('active');
        document.getElementById('tab-creditos-cliente').classList.remove('active');
        document.getElementById('historial-content').classList.add('active');
        document.getElementById('creditos-cliente-content').classList.remove('active');
        loadClientSalesHistory();
      });
      document.getElementById('tab-creditos-cliente').addEventListener('click', ()=>{
        document.getElementById('tab-creditos-cliente').classList.add('active');
        document.getElementById('tab-historial').classList.remove('active');
        document.getElementById('creditos-cliente-content').classList.add('active');
        document.getElementById('historial-content').classList.remove('active');
        loadClientCredits();
      });

      document.getElementById('close-detail-btn').addEventListener('click', ()=>{
        document.getElementById('credit-detail-container').classList.add('hidden');
        document.getElementById('credits-list-container').classList.remove('hidden');
      });
      document.getElementById('btn-generar-pdf').addEventListener('click', generarPDF);
      document.getElementById('btn-enviar-whatsapp').addEventListener('click', generateWhatsAppMessage);
      document.getElementById('copy-whatsapp-message-btn').addEventListener('click', copyWhatsAppMessage);
      document.getElementById('close-whatsapp-modal-btn').addEventListener('click', ()=>{ document.getElementById('whatsapp-modal').style.display='none'; });

      // Cargar datos iniciales
      (async ()=>{
        await Promise.all([listenForProducts(), listenForCredits(), listenForSales(), listenForClients()]);
      })();
    });
  </script>
</body>
</html>

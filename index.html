<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bodega Maria's</title>
  <meta name="theme-color" content="#e0e5ec"/>
  <link rel="manifest" href="manifest.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    body{font-family:'Inter',sans-serif;background:#e0e5ec;color:#4b5563;min-height:100vh;margin:0}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .card{background:#e0e5ec;border-radius:2rem;box-shadow:9px 9px 16px #a3b1c6,-9px -9px 16px #fff}
    .inset{background:#e0e5ec;border-radius:1rem;box-shadow:inset 5px 5px 10px #a3b1c6,inset -5px -5px 10px #fff}
    .btn{background:#e0e5ec;border-radius:999px;box-shadow:5px 5px 10px #a3b1c6,-5px -5px 10px #fff;transition:.2s}
    .btn:active{box-shadow:inset 5px 5px 10px #a3b1c6,inset -5px -5px 10px #fff}
    .input{background:#e0e5ec;border:none;outline:none;border-radius:.9rem;box-shadow:inset 2px 2px 5px #a3b1c6,inset -2px -2px 5px #fff;padding:.75rem;width:100%}
    .pill{border-radius:999px;padding:.35rem .8rem;font-weight:700}
    .menu{position:sticky;top:0;z-index:10}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card p-4 mb-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">Bodega Maria's</h1>
      <nav class="menu flex gap-2">
        <button class="btn px-4 py-2 text-sm" data-go="productos">Productos</button>
        <button class="btn px-4 py-2 text-sm" data-go="ventas">Ventas</button>
        <button class="btn px-4 py-2 text-sm" data-go="creditos">Créditos</button>
        <button class="btn px-4 py-2 text-sm" data-go="clientes">Clientes</button>
        <button class="btn px-4 py-2 text-sm" data-go="reportes">Reportes</button>
      </nav>
    </header>

    <!-- Productos -->
    <section id="sec-productos" class="card p-4 mb-6">
      <h2 class="text-xl font-semibold mb-3">Gestión de productos</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="inset p-3">
          <input id="srchProd" class="input mb-3" placeholder="Buscar..."/>
          <ul id="listProd" class="max-h-72 overflow-auto text-sm"></ul>
        </div>
        <div class="inset p-3">
          <h3 id="prodFormTitle" class="font-semibold mb-2">Agregar producto</h3>
          <input type="hidden" id="prodId"/>
          <label class="text-xs font-semibold">Nombre</label>
          <input id="prodName" class="input mb-2" placeholder="Galleta Field"/>
          <label class="text-xs font-semibold">Precio (S/)</label>
          <input id="prodPrice" class="input mb-2" type="number" step="0.01" min="0"/>
          <label class="text-xs font-semibold">Stock</label>
          <input id="prodStock" class="input mb-2" type="number" step="0.01" min="0"/>
          <label class="text-xs font-semibold">Unidad</label>
          <select id="prodUnit" class="input mb-2">
            <option value="UN">UN</option><option value="KG">KG</option><option value="LT">LT</option>
          </select>
          <label class="text-xs font-semibold">Caducidad</label>
          <input id="prodExpiry" class="input mb-3" type="date"/>
          <button id="btnSaveProd" class="btn w-full py-3 font-semibold">Guardar</button>
        </div>
      </div>
    </section>

    <!-- Ventas -->
    <section id="sec-ventas" class="card p-4 mb-6 hide">
      <h2 class="text-xl font-semibold mb-3">Registro de ventas</h2>
      <div class="inset p-3">
        <div class="grid md:grid-cols-4 gap-3">
          <div class="md:col-span-2">
            <label class="text-xs font-semibold">Producto</label>
            <input id="saleSearch" class="input" placeholder="Escribe para buscar..."/>
            <div id="acList" class="inset mt-2 p-2 text-sm hide"></div>
          </div>
          <div>
            <label class="text-xs font-semibold">Cantidad</label>
            <input id="saleQty" type="number" step="0.01" min="0.01" class="input"/>
          </div>
          <div>
            <label class="text-xs font-semibold">Cliente</label>
            <input id="saleClient" class="input" placeholder="Nombre del cliente"/>
          </div>
        </div>
        <div class="flex gap-2 mt-3">
          <button id="btnAddCart" class="btn px-4 py-2">Agregar</button>
          <button id="btnSaleCash" class="btn px-4 py-2 pill">Contado</button>
          <button id="btnSaleCredit" class="btn px-4 py-2">Fiado</button>
          <button id="btnCommitSale" class="btn px-4 py-2 font-semibold ml-auto">Registrar venta</button>
        </div>
        <div class="inset mt-3 p-3">
          <h4 class="font-semibold mb-2">Carrito</h4>
          <ul id="cartList" class="text-sm"></ul>
          <div class="flex justify-between mt-2 font-bold"><span>Total</span><span id="cartTotal">S/ 0.00</span></div>
        </div>
      </div>
    </section>

    <!-- Créditos -->
    <section id="sec-creditos" class="card p-4 mb-6 hide">
      <h2 class="text-xl font-semibold mb-3">Gestión de créditos</h2>
      <div class="inset p-3">
        <ul id="listCred" class="text-sm"></ul>
      </div>
      <div id="credDetail" class="inset p-3 mt-3 hide">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Detalle de deuda</h3>
          <button id="btnCloseCred" class="btn px-3 py-1 text-sm">Cerrar</button>
        </div>
        <div class="mt-2">
          <p>Cliente: <b id="credName"></b></p>
          <p>Total: <b id="credTotal"></b></p>
          <p>Fecha: <span id="credDate"></span></p>
          <ul id="credItems" class="mt-2 text-sm"></ul>
        </div>
        <div class="flex gap-2 mt-3">
          <button id="btnCredPDF" class="btn px-4 py-2">PDF</button>
          <button id="btnCredWA" class="btn px-4 py-2">WhatsApp</button>
          <button id="btnCredPaid" class="btn px-4 py-2 ml-auto">Marcar pagado</button>
        </div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="sec-clientes" class="card p-4 mb-6 hide">
      <h2 class="text-xl font-semibold mb-3">Clientes</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="inset p-3">
          <h3 class="font-semibold mb-2">Agregar/Editar</h3>
          <input type="hidden" id="cliId"/>
          <label class="text-xs font-semibold">Nombre</label>
          <input id="cliName" class="input mb-2"/>
          <label class="text-xs font-semibold">Teléfono</label>
          <input id="cliPhone" class="input mb-2"/>
          <label class="text-xs font-semibold">Notas</label>
          <textarea id="cliNotes" class="input mb-3" rows="3"></textarea>
          <button id="btnSaveClient" class="btn w-full py-3 font-semibold">Guardar</button>
        </div>
        <div class="inset p-3">
          <input id="srchCli" class="input mb-2" placeholder="Buscar cliente..."/>
          <ul id="listCli" class="max-h-72 overflow-auto text-sm"></ul>
        </div>
      </div>
    </section>

    <!-- Reportes -->
    <section id="sec-reportes" class="card p-4 mb-12 hide">
      <h2 class="text-xl font-semibold mb-3">Reportes</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="inset p-3">
          <div class="flex justify-between"><span>Ventas hoy</span><b id="repToday">S/ 0.00</b></div>
          <div class="flex justify-between"><span>Semana</span><b id="repWeek">S/ 0.00</b></div>
          <div class="flex justify-between"><span>Mes</span><b id="repMonth">S/ 0.00</b></div>
        </div>
        <div class="inset p-3 md:col-span-2">
          <h4 class="font-semibold mb-2">Stock bajo (&lt; 5)</h4>
          <ul id="repLow" class="text-sm"></ul>
        </div>
      </div>
    </section>

    <footer class="text-center text-xs text-gray-500 mb-6">
      © <span id="y"></span> Francisco Vera — Dattec. Todos los derechos reservados.
    </footer>
  </div>

  <script>
    // ====== CONFIG ======
    const API_URL = 'AKfycbzn4ZjRMgK239Xin62yVIbegae6foMhYvX6CMuJ-IDTA421lcdfC4rwMQCF2_uQhGyR'; // Ej: https://script.google.com/macros/s/AKfycb.../exec

    // ====== PWA ======
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // ====== HELPERS ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const money = n => `S/ ${Number(n||0).toFixed(2)}`;

    async function api(action, params={}) {
      const q = new URLSearchParams({action, ...params});
      const url = `${API_URL}?${q.toString()}`;
      const res = await fetch(url, {method:'GET'});
      if (!res.ok) throw new Error('Sin conexión');
      const json = await res.json();
      if (!json.ok) throw new Error(json.error||'Error');
      return json.data;
    }

    // ====== NAV ======
    $$('.menu [data-go]').forEach(b => {
      b.addEventListener('click', () => {
        const id = b.dataset.go;
        ['productos','ventas','creditos','clientes','reportes'].forEach(k=>{
          $('#sec-'+k).classList.toggle('hide', k!==id);
        });
      });
    });

    // ====== DATA STATE ======
    let allProducts = [];
    let allSales = [];
    let allCredits = [];
    let allClients = [];
    let cart = [];
    let paymentType = 'Contado';
    let credSelected = null;

    // ====== PRODUCTOS ======
    async function loadProducts() {
      allProducts = await api('listProducts');
      renderProducts();
      renderLowStock();
    }
    function renderProducts(){
      const ul = $('#listProd'); ul.innerHTML='';
      const q = ($('#srchProd').value||'').toLowerCase();
      allProducts.filter(p => p.name.toLowerCase().includes(q)).forEach(p=>{
        const li = document.createElement('li');
        li.className='inset p-2 mb-2 flex items-center justify-between';
        li.innerHTML = `
          <div>
            <div class="font-semibold">${p.name}</div>
            <div class="text-xs text-gray-500">Stock: ${p.stock} ${p.unit} • Cad: ${p.expiry||'-'}</div>
          </div>
          <div class="flex items-center gap-2">
            <b>${money(p.price)}</b>
            <button class="btn px-3 py-1 text-xs" data-edit="${p.id}">Editar</button>
            <button class="btn px-3 py-1 text-xs" data-del="${p.id}">Borrar</button>
          </div>`;
        ul.appendChild(li);
      });

      ul.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.onclick=()=>{
          const p = allProducts.find(x=>x.id===btn.dataset.edit);
          if (!p) return;
          $('#prodFormTitle').textContent='Editar producto';
          $('#prodId').value=p.id;
          $('#prodName').value=p.name;
          $('#prodPrice').value=p.price;
          $('#prodStock').value=p.stock;
          $('#prodUnit').value=p.unit;
          $('#prodExpiry').value=p.expiry||'';
        };
      });
      ul.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick=async()=>{
          if(confirm('¿Eliminar producto?')){
            await api('deleteProduct',{id:btn.dataset.del});
            await loadProducts();
          }
        };
      });
    }

    $('#srchProd').addEventListener('input', renderProducts);
    $('#btnSaveProd').onclick = async ()=>{
      const params = {
        id: $('#prodId').value,
        name: $('#prodName').value.trim(),
        price: $('#prodPrice').value,
        stock: $('#prodStock').value,
        unit: $('#prodUnit').value,
        expiry: $('#prodExpiry').value
      };
      if (!params.name) { alert('Nombre requerido'); return; }
      await api('upsertProduct', params);
      ['#prodId','#prodName','#prodPrice','#prodStock','#prodExpiry'].forEach(sel=>$(sel).value='');
      $('#prodUnit').value='UN';
      $('#prodFormTitle').textContent='Agregar producto';
      await loadProducts();
    };

    // ====== VENTAS ======
    function acRender(list){
      const box = $('#acList'); box.innerHTML=''; box.classList.toggle('hide', list.length===0);
      list.forEach(p=>{
        const d = document.createElement('div');
        d.className='inset p-2 mb-2 cursor-pointer';
        d.textContent = `${p.name} — ${money(p.price)} (St: ${p.stock} ${p.unit})`;
        d.onclick=()=>{ $('#saleSearch').value=p.name; $('#acList').classList.add('hide'); $('#saleSearch').dataset.id=p.id; };
        box.appendChild(d);
      });
    }
    $('#saleSearch').addEventListener('input', ()=>{
      const q = $('#saleSearch').value.toLowerCase();
      if (q.length<2) { $('#acList').classList.add('hide'); return; }
      acRender(allProducts.filter(p=>p.name.toLowerCase().includes(q)));
    });
    $('#btnAddCart').onclick=()=>{
      const id = $('#saleSearch').dataset.id;
      const p = allProducts.find(x=>x.id===id);
      const qty = parseFloat($('#saleQty').value||'0');
      if (!p || isNaN(qty) || qty<=0) { alert('Producto/cantidad inválidos'); return; }
      if (qty > Number(p.stock||0)) { alert('Stock insuficiente'); return; }
      const i = cart.findIndex(x=>x.id===id);
      if (i>=0) cart[i].quantity = Number((cart[i].quantity+qty).toFixed(2));
      else cart.push({id:p.id, name:p.name, price:Number(p.price), unit:p.unit, quantity:qty});
      $('#saleSearch').value=''; $('#saleSearch').dataset.id=''; $('#saleQty').value='';
      renderCart();
    };
    function renderCart(){
      const ul = $('#cartList'); ul.innerHTML='';
      let tot=0;
      cart.forEach(it=>{
        const li=document.createElement('li');
        const sub = it.price*it.quantity; tot += sub;
        li.className='flex justify-between border-b border-gray-300 py-1';
        li.innerHTML=`<span>${it.name} x ${it.quantity} ${it.unit}</span><b>${money(sub)}</b>`;
        ul.appendChild(li);
      });
      $('#cartTotal').textContent = money(tot);
    }
    $('#btnSaleCash').onclick=()=>{paymentType='Contado'; $('#btnSaleCash').classList.add('pill'); $('#btnSaleCredit').classList.remove('pill');};
    $('#btnSaleCredit').onclick=()=>{paymentType='Fiado'; $('#btnSaleCredit').classList.add('pill'); $('#btnSaleCash').classList.remove('pill');};
    $('#btnCommitSale').onclick=async()=>{
      if (cart.length===0) { alert('Carrito vacío'); return; }
      const total = cart.reduce((s,it)=>s+it.price*it.quantity,0);
      await api('recordSale',{
        customerName: $('#saleClient').value||'Cliente Anónimo',
        paymentType,
        itemsJSON: JSON.stringify(cart),
        total: total.toFixed(2)
      });
      cart=[]; renderCart(); $('#saleClient').value='';
      await Promise.all([loadProducts(), loadSales(), loadCredits(), renderReports()]);
      alert('Venta registrada');
    };

    // ====== CRÉDITOS ======
    async function loadCredits() {
      allCredits = await api('listCredits');
      renderCredits();
    }
    function renderCredits(){
      const ul = $('#listCred'); ul.innerHTML='';
      if (allCredits.length===0){ ul.innerHTML='<li class="text-gray-500">Sin deudas.</li>'; return; }
      allCredits.forEach(c=>{
        const li=document.createElement('li');
        li.className='inset p-2 mb-2 flex justify-between items-center';
        li.innerHTML=`<div><b>${c.customerName}</b><div class="text-xs text-gray-500">${new Date(c.timestamp).toLocaleString('es-PE')}</div></div><div class="flex items-center gap-2"><b>${money(c.total)}</b><button class="btn px-3 py-1 text-xs" data-open="${c.id}">Ver</button></div>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll('[data-open]').forEach(b=>{
        b.onclick=()=>{
          credSelected = allCredits.find(x=>x.id===b.dataset.open);
          if (!credSelected) return;
          $('#credName').textContent=credSelected.customerName;
          $('#credTotal').textContent=money(credSelected.total);
          $('#credDate').textContent=new Date(credSelected.timestamp).toLocaleString('es-PE');
          const ul2=$('#credItems'); ul2.innerHTML='';
          (credSelected.items||[]).forEach(it=>{
            const li=document.createElement('li');
            li.className='flex justify-between border-b border-gray-300 py-1';
            li.innerHTML=`<span>${it.name} x ${it.quantity} ${it.unit}</span><b>${money(it.price*it.quantity)}</b>`;
            ul2.appendChild(li);
          });
          $('#credDetail').classList.remove('hide');
        };
      });
    }
    $('#btnCloseCred').onclick=()=>$('#credDetail').classList.add('hide');
    $('#btnCredPaid').onclick=async()=>{
      if (!credSelected) return;
      await api('payCredit',{id:credSelected.id});
      $('#credDetail').classList.add('hide');
      await loadCredits();
      alert('Crédito marcado como pagado');
    };
    // PDF & WhatsApp (simple)
    $('#btnCredPDF').onclick=()=>{
      if (!credSelected) return;
      const txt = `Deuda de ${credSelected.customerName}\nTotal: ${money(credSelected.total)}\n` + (credSelected.items||[]).map(it=>`- ${it.name} x ${it.quantity} ${it.unit} = ${money(it.price*it.quantity)}`).join('\n');
      const blob = new Blob([txt], {type:'text/plain'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`deuda_${credSelected.customerName.replace(/\s/g,'_')}.txt`; a.click();
    };
    $('#btnCredWA').onclick=()=>{
      if (!credSelected) return;
      const msg = encodeURIComponent(`Hola ${credSelected.customerName}, tu saldo pendiente es ${money(credSelected.total)}.`);
      window.open(`https://wa.me/?text=${msg}`,'_blank');
    };

    // ====== CLIENTES ======
    async function loadClients(){ allClients = await api('listClients'); renderClients(); }
    function renderClients(){
      const ul = $('#listCli'); ul.innerHTML='';
      const q = ($('#srchCli').value||'').toLowerCase();
      allClients.filter(c=>c.name.toLowerCase().includes(q)).forEach(c=>{
        const li=document.createElement('li');
        li.className='inset p-2 mb-2 flex justify-between items-center';
        li.innerHTML=`<div><b>${c.name}</b><div class="text-xs text-gray-500">${c.phone||'-'}</div></div><button class="btn px-3 py-1 text-xs" data-edit="${c.id}">Editar</button>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll('[data-edit]').forEach(b=>{
        b.onclick=()=>{
          const c=allClients.find(x=>x.id===b.dataset.edit); if(!c) return;
          $('#cliId').value=c.id; $('#cliName').value=c.name; $('#cliPhone').value=c.phone||''; $('#cliNotes').value=c.notes||'';
        };
      });
    }
    $('#srchCli').addEventListener('input', renderClients);
    $('#btnSaveClient').onclick=async()=>{
      const name = $('#cliName').value.trim();
      if (!name) { alert('Nombre requerido'); return; }
      await api('upsertClient',{
        id: $('#cliId').value,
        name,
        phone: $('#cliPhone').value,
        notes: $('#cliNotes').value
      });
      ['#cliId','#cliName','#cliPhone','#cliNotes'].forEach(sel=>$(sel).value='');
      await loadClients();
    };

    // ====== REPORTES ======
    async function loadSales(){ allSales = await api('listSales'); }
    function renderLowStock(){
      const ul = $('#repLow'); if(!ul) return;
      ul.innerHTML='';
      const low = allProducts.filter(p=>Number(p.stock)<5);
      if (low.length===0){ ul.innerHTML='<li class="text-gray-500">Sin alertas.</li>'; return; }
      low.forEach(p=>{
        const li=document.createElement('li'); li.className='text-red-600'; li.textContent=`${p.name} (Stock: ${p.stock} ${p.unit})`;
        ul.appendChild(li);
      });
    }
    function renderReports(){
      const today = new Date();
      const weekAgo = new Date(); weekAgo.setDate(today.getDate()-7);
      const monthAgo = new Date(); monthAgo.setMonth(today.getMonth()-1);

      let t=0,w=0,m=0;
      allSales.forEach(s=>{
        const d = new Date(s.timestamp);
        if (d.toDateString() === today.toDateString()) t += Number(s.total||0);
        if (d >= weekAgo) w += Number(s.total||0);
        if (d >= monthAgo) m += Number(s.total||0);
      });
      $('#repToday').textContent=money(t);
      $('#repWeek').textContent=money(w);
      $('#repMonth').textContent=money(m);
    }

    // ====== INIT ======
    (async function init(){
      $('#y').textContent = new Date().getFullYear();
      try {
        await Promise.all([loadProducts(), loadSales(), loadCredits(), loadClients()]);
        renderReports();
      } catch (e){
        console.error(e);
        alert('Sin conexión: revisa tu URL de Apps Script (EXEC) y despliegue público.');
      }
    })();
  </script>
</body>
</html>
